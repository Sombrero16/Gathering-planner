<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curra's OnlyFarms</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .form-select, .form-input {
            background-color: #2d3748; /* bg-gray-700 */
        }
        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Tooltip styles */
        .tooltip-container {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .question-mark {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background-color: #4a5568; /* bg-gray-600 */
            color: white;
            text-align: center;
            font-size: 0.75rem;
            line-height: 1rem;
            margin-left: 0.5rem;
            cursor: pointer;
            user-select: none;
        }

        .tooltip-text {
            visibility: hidden;
            width: max-content; /* Let the bubble be as wide as its content... */
            max-width: 300px;   /* ...but no wider than this, forcing text to wrap. */
            background-color: #1a202c; /* bg-gray-900 */
            color: #fff;
            text-align: center;
            border: 1px solid #4a5568; /* border-gray-600 */
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%; /* Position above the icon */
            left: 50%;
            transform: translateX(-50%); /* Center the tooltip */
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem; /* text-xs */
            font-weight: 400; /* font-normal */
            line-height: 1.25;
            pointer-events: none; /* Make sure tooltip doesn't interfere with hover */
        }

        /* Arrow for the tooltip */
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1a202c transparent transparent transparent;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Guide styles */
        .guide-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }

        .guide-arrow {
            transition: transform 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-white p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8 flex items-center justify-center space-x-6">
             <img src="https://raw.githubusercontent.com/Sombrero16/Gathering-planner/main/assets/pictures/image02.jpg" alt="Decorative image" class="w-24 h-24 sm:w-32 sm:h-32 rounded-xl border-2 border-cyan-400 object-cover">
            <div>
                <h1 class="text-3xl sm:text-4xl font-bold text-cyan-400">Curra´s OnlyFarms</h1>
                <p class="text-xs sm:text-sm text-white-400 font-medium italic mt-2">Courtesy of <a href="./index.html" class="text-white no-underline">S</a>16</p>
                <p class="text-gray-400 mt-2">Find the optimal gathering plan to maximize your final bonus.</p>
            </div>
            <img src="https://raw.githubusercontent.com/Sombrero16/Gathering-planner/main/assets/pictures/image01.jpg" alt="Decorative image" class="w-24 h-24 sm:w-32 sm:h-32 rounded-xl border-2 border-cyan-400 object-cover">
        </header>

        <!-- Quick Guide Section -->
        <div class="bg-gray-800 rounded-xl shadow-lg mb-6">
            <button id="guide-toggle" class="w-full flex justify-between items-center p-4 text-left font-semibold text-cyan-400 focus:outline-none">
                <span>Quick Guide: Maximize Your Gathering Bonus</span>
                <svg id="guide-arrow" class="guide-arrow w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="guide-content" class="guide-content px-4">
                <div class="pb-4 text-gray-300 text-sm space-y-4">
                    <p>This tool calculates the optimal two-step plan to maximize the "Increased resource gained" bonus on your march (pre-fill & final gather).</p>
                    <div>
                        <h4 class="font-semibold text-white mb-2">The Core Strategy</h4>
                        <p>The goal is to ensure your march's Load Capacity is exactly full enough before it enters the long-duration Final Gather node (e.g., the Alliance Center), massively increasing your final haul.</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-white mb-2">Step-by-Step Plan</h4>
                        <ol class="list-decimal list-inside space-y-2">
                            <li><strong class="text-gray-200">Input Stats (Edit Your Stats):</strong> Enter your march's Load, Speed %, and Bonus %. Also, input your individual Resource Speeds—the tool uses your highest speed resource for the Pre-fill plan.</li>
                            <li><strong class="text-gray-200">Set Buffs (Calculator Settings):</strong> Select your Global Speed, Load Bonus, and crucially, the Time remaining on the Alliance Center.</li>
                            <li><strong class="text-gray-200">Toggle Nodes (Node Status):</strong> Check the boxes for any special, high-capacity nodes (T7, T6 Rich) available on your map to include in the calculation.</li>
                        </ol>
                    </div>
                     <div>
                        <h4 class="font-semibold text-white mb-2">Follow the Plan (Your Optimal Plan)</h4>
                         <ol class="list-decimal list-inside space-y-2">
                             <li><strong class="text-gray-200">Pre-fill Steps:</strong> Gather the exact (~) amount specified from the suggested nodes (Step 1, 2, 3...) to fill your march's pre-fill capacity. This way you will have exactly enough capacity available, to fill the entire last node / remaining resource center.</li>
                              <li><strong class="text-gray-200">Final Gather:</strong> Send the march to the Resource Center or biggest available node for the remaining time, to gain maximum bonus resources.</li>
                         </ol>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left Panel: Settings -->
            <div class="lg-col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-6 border-b border-gray-700 pb-3">1. Calculator Settings</h2>
                
                <div class="space-y-4">
                    <div>
                        <label for="select-march" class="block text-sm font-medium text-gray-300 mb-1">Select March</label>
                        <select id="select-march" class="form-select w-full border-gray-600 text-white rounded-md shadow-sm focus:border-cyan-500 focus:ring focus:ring-cyan-500 focus:ring-opacity-50"></select>
                    </div>
                    <div>
                        <label for="select-center" class="block text-sm font-medium text-gray-300 mb-1">Select Resource Center</label>
                        <select id="select-center" class="form-select w-full border-gray-600 text-white rounded-md shadow-sm focus:border-cyan-500 focus:ring focus:ring-cyan-500 focus:ring-opacity-50"></select>
                    </div>
                     <div>
                        <label for="select-rich-resource" class="block text-sm font-medium text-gray-300 mb-1">Select Rich Resource</label>
                        <select id="select-rich-resource" class="form-select w-full border-gray-600 text-white rounded-md shadow-sm focus:border-cyan-500 focus:ring focus:ring-cyan-500 focus:ring-opacity-50"></select>
                    </div>
                    <div>
                        <label for="select-global-speed" class="block text-sm font-medium text-gray-300 mb-1">
                            <span>Global Speed Buff</span>
                            <span class="tooltip-container">
                                <span class="question-mark">?</span>
                                <span class="tooltip-text">Kingdom Buffs activated by the King</span>
                            </span>
                        </label>
                        <select id="select-global-speed" class="form-select w-full border-gray-600 text-white rounded-md shadow-sm focus:border-cyan-500 focus:ring focus:ring-cyan-500 focus:ring-opacity-50"></select>
                    </div>
                    <div>
                        <label for="select-load-bonus" class="block text-sm font-medium text-gray-300 mb-1">
                           <span>Load Bonus</span>
                            <span class="tooltip-container">
                                <span class="question-mark">?</span>
                                <span class="tooltip-text">Unit Capacity Booster</span>
                            </span>
                        </label>
                        <select id="select-load-bonus" class="form-select w-full border-gray-600 text-white rounded-md shadow-sm focus:border-cyan-500 focus:ring focus:ring-cyan-500 focus:ring-opacity-50"></select>
                    </div>
                    <div>
                        <label for="time-at-center" class="block text-sm font-medium text-gray-300 mb-1">
                            <span>Time at Resource Center (HH:MM)</span>
                             <span class="tooltip-container">
                                <span class="question-mark">?</span>
                                <span class="tooltip-text">Time left at the Alliance Resource Center</span>
                            </span>
                        </label>
                        <input type="text" id="time-at-center" value="12:30" class="form-input w-full border-gray-600 text-white rounded-md shadow-sm focus:border-cyan-500 focus:ring focus:ring-cyan-500 focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="select-civilization" class="block text-sm font-medium text-gray-300 mb-1">
                            <span>Civilization</span>
                            <span class="tooltip-container">
                                <span class="question-mark">?</span>
                                <span class="tooltip-text">Some Civilizations provide certain additional gathering skills</span>
                            </span>
                        </label>
                        <select id="select-civilization" class="form-select w-full border-gray-600 text-white rounded-md shadow-sm focus:border-cyan-500 focus:ring focus:ring-cyan-500 focus:ring-opacity-50">
                            <option value="other">Other</option>
                            <option value="byzantines">Byzantines</option>
                            <option value="egyptian">Egyptian</option>
                        </select>
                        <p id="byzantines-notice" class="text-xs text-gray-400 mt-1 hidden">Note: Byzantinian civilization provides a 5% stone gathering speed bonus.</p>
                        <p id="egyptian-notice" class="text-xs text-gray-400 mt-1 hidden">Note: Egyptian civilization provides a 5% troop load bonus.</p>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Chief Elder Title</label>
                        <label class="flex items-center space-x-2 text-sm cursor-pointer">
                            <input type="checkbox" id="imperial-title" class="form-checkbox h-4 w-4 bg-gray-700 border-gray-600 rounded text-cyan-500 focus:ring-cyan-600">
                            <span class="text-gray-300">Enabled</span>
                        </label>
                    </div>
                </div>

                <h2 class="text-xl font-semibold mt-8 mb-4 border-b border-gray-700 pb-3">Node Status</h2>
                <div id="nodes-table" class="space-y-3">
                    <!-- Node checkboxes will be generated here -->
                </div>

                <h2 class="text-xl font-semibold mt-8 mb-4 border-b border-gray-700 pb-3">Edit Your Stats</h2>
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-200">
                        <span>Marches</span>
                        <span class="tooltip-container">
                            <span class="question-mark">?</span>
                            <span class="tooltip-text" style="text-align: left; bottom: 125%;">&bull; Speed: Shown as Gathering Bonus % on your march Overview<br>&bull; Bonus: The combined percentage of "Increased resource gained" from the Talent Tree and Hero Skills<br>&bull; Load: Shown as Load on your march Overview</span>
                        </span>
                    </h3>
                    <div id="march-editor" class="space-y-3"></div>
                    <h3 class="text-lg font-medium text-gray-200 mt-4">
                        <span>Resource Speeds</span>
                        <span class="tooltip-container">
                            <span class="question-mark">?</span>
                            <span class="tooltip-text">Certain resource gathering speed</span>
                        </span>
                    </h3>
                    <div id="resource-editor" class="space-y-3"></div>
                </div>
            </div>

            <!-- Right Panel: Results -->
            <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-6 border-b border-gray-700 pb-3">2. Your Optimal Plan</h2>
                <div id="results-container" class="space-y-4">
                    <!-- Results will be generated here -->
                </div>
            </div>
        </div>
    </div>

<script>
    // --- DATA CONFIGURATION ---
    const config = {
        marches: [
            { id: 1, name: 'March 1', speedBonus: 3.17, finalBonus: 0.60, baseLoad: 25000000 },
            { id: 2, name: 'March 2', speedBonus: 3.28, finalBonus: 0.34, baseLoad: 25000000 },
            { id: 3, name: 'March 3', speedBonus: 2.09, finalBonus: 0.35, baseLoad: 18000000 },
            { id: 4, name: 'March 4', speedBonus: 2.55, finalBonus: 0.53, baseLoad: 24000000 },
            { id: 5, name: 'March 5', speedBonus: 2.75, finalBonus: 0.40, baseLoad: 18000000 }
        ],
        resources: [
            { name: 'Wood', speedBonus: 0.49 },
            { name: 'Food', speedBonus: 0.59 },
            { name: 'Stone', speedBonus: 0.48 },
            { name: 'Gold', speedBonus: 0.59 }
        ],
        globalSpeeds: [
            { name: 'No Global', speedBonus: 0.00 },
            { name: 'One Global', speedBonus: 0.10 },
            { name: 'Two Globals', speedBonus: 0.20 }
        ],
        loadBonuses: [
            { name: '0% Bonus', bonus: 0.00 },
            { name: '10% Bonus', bonus: 0.10 },
            { name: '20% Bonus', bonus: 0.20 },
            { name: '30% Bonus', bonus: 0.30 }
        ],
        centerNodes: [
            { id: 'rc_wood', name: 'Resource Center (Wood)', baseSpeed: 250000, capacity: 800000000, repeatable: false, available: true },
            { id: 'rc_food', name: 'Resource Center (Food)', baseSpeed: 250000, capacity: 800000000, repeatable: false, available: true },
            { id: 'rc_stone', name: 'Resource Center (Stone)', baseSpeed: 250000, capacity: 800000000, repeatable: false, available: true },
            { id: 'rc_gold', name: 'Resource Center (Gold)', baseSpeed: 250000, capacity: 800000000, repeatable: false, available: true },
        ],
        nodes: [
            { name: 'T7', baseSpeed: 210000, capacity: 5292000, available: true, repeatable: false },
            { name: 'T6 Rich', baseSpeed: 420000, capacity: 12600000, available: true, repeatable: false },
            { name: 'T6', baseSpeed: 210000, capacity: 3780000, available: true, repeatable: true },
            { name: 'T5', baseSpeed: 200000, capacity: 2160000, available: true, repeatable: true },
            { name: 'T4', baseSpeed: 190000, capacity: 912000, available: true, repeatable: true }
        ]
    };

    // --- DOM ELEMENTS ---
    const UIElements = {
        marchSelect: document.getElementById('select-march'),
        centerSelect: document.getElementById('select-center'),
        richResourceSelect: document.getElementById('select-rich-resource'),
        globalSpeedSelect: document.getElementById('select-global-speed'),
        loadBonusSelect: document.getElementById('select-load-bonus'),
        timeAtCenterInput: document.getElementById('time-at-center'),
        nodesTable: document.getElementById('nodes-table'),
        resultsContainer: document.getElementById('results-container'),
        marchEditor: document.getElementById('march-editor'),
        resourceEditor: document.getElementById('resource-editor'),
        imperialTitle: document.getElementById('imperial-title'),
        civilizationSelect: document.getElementById('select-civilization'),
        egyptianNotice: document.getElementById('egyptian-notice'),
        byzantinesNotice: document.getElementById('byzantines-notice'),
        guideToggle: document.getElementById('guide-toggle'),
        guideContent: document.getElementById('guide-content'),
        guideArrow: document.getElementById('guide-arrow'),
    };

    // --- INITIALIZATION ---
    function init() {
        populateSelect(UIElements.marchSelect, config.marches, 'name', 'id');
        populateSelect(UIElements.centerSelect, config.centerNodes, 'name', 'id');
        UIElements.centerSelect.value = 'rc_food'; // Set default
        populateSelect(UIElements.richResourceSelect, config.resources, 'name', 'name');
        populateSelect(UIElements.globalSpeedSelect, config.globalSpeeds, 'name', 'speedBonus');
        populateSelect(UIElements.loadBonusSelect, config.loadBonuses, 'name', 'bonus');
        populateNodes();
        populateEditors();
        
        // Add event listeners
        Object.values(UIElements).forEach(el => {
            if (el && (el.tagName === 'SELECT' || el.tagName === 'INPUT')) {
                el.addEventListener('change', calculatePlan);
            }
        });
        UIElements.timeAtCenterInput.addEventListener('keyup', calculatePlan);
        UIElements.guideToggle.addEventListener('click', () => {
            const isExpanded = UIElements.guideContent.style.maxHeight;
            if (isExpanded && isExpanded !== '0px') {
                UIElements.guideContent.style.maxHeight = '0px';
                UIElements.guideArrow.style.transform = 'rotate(0deg)';
            } else {
                UIElements.guideContent.style.maxHeight = UIElements.guideContent.scrollHeight + 'px';
                UIElements.guideArrow.style.transform = 'rotate(180deg)';
            }
        });

        // Initial calculation
        calculatePlan();
    }

    function populateSelect(selectElement, items, nameKey, valueKey) {
        selectElement.innerHTML = '';
        items.forEach(item => {
            const option = document.createElement('option');
            option.textContent = item[nameKey];
            option.value = item[valueKey];
            selectElement.appendChild(option);
        });
    }

    function populateNodes() {
        UIElements.nodesTable.innerHTML = '';
        const specialNodeNames = ['T7', 'T6 Rich'];

        specialNodeNames.forEach(nodeName => {
            const node = config.nodes.find(n => n.name === nodeName);
            const nodeIndex = config.nodes.findIndex(n => n.name === nodeName);
            if (!node) return;

            const nodeDiv = document.createElement('div');
            nodeDiv.className = 'flex items-center justify-between bg-gray-700 p-2 rounded-md';

            nodeDiv.innerHTML = `
                <div>
                    <span class="font-medium">${node.name}</span>
                </div>
                <div class="text-right">
                    <label class="flex items-center justify-end space-x-2 text-xs cursor-pointer">
                        <input type="checkbox" data-index="${nodeIndex}" data-prop="available" class="form-checkbox h-4 w-4 bg-gray-800 border-gray-600 rounded text-cyan-500 focus:ring-cyan-600" ${node.available ? 'checked' : ''}>
                        <span>Available</span>
                    </label>
                    <label class="flex items-center justify-end space-x-2 text-xs cursor-pointer mt-2">
                        <input type="checkbox" data-index="${nodeIndex}" data-prop="repeatable" class="form-checkbox h-4 w-4 bg-gray-800 border-gray-600 rounded text-cyan-500 focus:ring-cyan-600" ${node.repeatable ? 'checked' : ''}>
                        <span>Repeatable</span>
                    </label>
                </div>
            `;
            
            UIElements.nodesTable.appendChild(nodeDiv);
        });

        UIElements.nodesTable.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            if (checkbox.id.includes('center')) return; // Skip center toggles already handled
            checkbox.addEventListener('change', (e) => {
                const index = e.target.dataset.index;
                const prop = e.target.dataset.prop;
                config.nodes[index][prop] = e.target.checked;
                calculatePlan();
            });
        });

        // Resource Center Toggles
        const centerDiv = document.createElement('div');
        centerDiv.className = 'flex items-center justify-between bg-gray-700 p-2 rounded-md';
        const centerIsAvailable = config.centerNodes[0]?.available;
        const centerIsRepeatable = config.centerNodes[0]?.repeatable;
        centerDiv.innerHTML = `
            <div>
                <span class="font-medium">Resource Center</span>
            </div>
            <div class="text-right">
                <label class="flex items-center justify-end space-x-2 text-xs cursor-pointer">
                    <input type="checkbox" id="center-available-toggle" class="form-checkbox h-4 w-4 bg-gray-800 border-gray-600 rounded text-cyan-500 focus:ring-cyan-600" ${centerIsAvailable ? 'checked' : ''}>
                    <span>Available</span>
                    <span class="tooltip-container">
                        <span class="question-mark">?</span>
                        <span class="tooltip-text">Might not be available, when prepping multiple marches in a shorter amount of time</span>
                    </span>
                </label>
                <label class="flex items-center justify-end space-x-2 text-xs cursor-pointer mt-2">
                    <input type="checkbox" id="center-repeatable-toggle" class="form-checkbox h-4 w-4 bg-gray-800 border-gray-600 rounded text-cyan-500 focus:ring-cyan-600" ${centerIsRepeatable ? 'checked' : ''}>
                    <span>Repeatable</span>
                    <span class="tooltip-container">
                        <span class="question-mark">?</span>
                        <span class="tooltip-text" style="text-align: left; bottom: 125%;">Do you have enough time, to pre-fill with the Resource Center or do you only have time to put every march in once and fill the rest with standard nodes</span>
                    </span>
                </label>
            </div>
        `;
        UIElements.nodesTable.appendChild(centerDiv);

        document.getElementById('center-available-toggle').addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            config.centerNodes.forEach(node => node.available = isChecked);
            calculatePlan();
        });
        document.getElementById('center-repeatable-toggle').addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            config.centerNodes.forEach(node => node.repeatable = isChecked);
            calculatePlan();
        });
    }

    function populateEditors() {
        // March Editor
        UIElements.marchEditor.innerHTML = '';
        config.marches.forEach((march, index) => {
            const marchDiv = document.createElement('div');
            marchDiv.className = 'p-3 bg-gray-700 rounded-md';
            marchDiv.innerHTML = `
                <p class="font-bold text-white mb-2">${march.name}</p>
                <div class="grid grid-cols-3 gap-2 text-xs">
                    <div>
                        <label class="block text-gray-400">Speed %</label>
                        <input type="number" value="${march.speedBonus * 100}" data-index="${index}" data-prop="speedBonus" class="form-input w-full p-1 rounded-sm">
                    </div>
                    <div>
                        <label class="block text-gray-400">Bonus %</label>
                        <input type="number" value="${march.finalBonus * 100}" data-index="${index}" data-prop="finalBonus" class="form-input w-full p-1 rounded-sm">
                    </div>
                    <div>
                        <label class="block text-gray-400">Load</label>
                        <input type="number" value="${march.baseLoad}" data-index="${index}" data-prop="baseLoad" class="form-input w-full p-1 rounded-sm">
                    </div>
                </div>
            `;
            UIElements.marchEditor.appendChild(marchDiv);
        });

        // Resource Editor
        UIElements.resourceEditor.innerHTML = '';
        config.resources.forEach((resource, index) => {
            const resourceDiv = document.createElement('div');
            resourceDiv.className = 'flex items-center justify-between bg-gray-700 p-2 rounded-md';
            resourceDiv.innerHTML = `
                <label class="text-gray-300 font-medium">${resource.name}</label>
                <div class="flex items-center space-x-2">
                    <input type="number" value="${resource.speedBonus * 100}" data-index="${index}" data-prop="speedBonus" class="form-input w-24 p-1 rounded-sm text-center">
                    <span class="text-gray-400">%</span>
                </div>
            `;
            UIElements.resourceEditor.appendChild(resourceDiv);
        });

        // Add event listeners for new inputs
        UIElements.marchEditor.querySelectorAll('input').forEach(input => {
            input.addEventListener('change', (e) => {
                const index = e.target.dataset.index;
                const prop = e.target.dataset.prop;
                let value = parseFloat(e.target.value);
                if (prop !== 'baseLoad') {
                    value /= 100; // Convert from percentage
                }
                config.marches[index][prop] = value;
                calculatePlan();
            });
        });

        UIElements.resourceEditor.querySelectorAll('input').forEach(input => {
            input.addEventListener('change', (e) => {
                const index = e.target.dataset.index;
                const prop = e.target.dataset.prop;
                const value = parseFloat(e.target.value) / 100;
                config.resources[index][prop] = value;
                calculatePlan();
            });
        });
    }

    // --- CALCULATION LOGIC ---
    function calculatePlan() {
        // 1. Get current values
        const selectedMarch = config.marches.find(m => m.id == UIElements.marchSelect.value);
        if (!selectedMarch) return;
        
        const selectedCenterId = UIElements.centerSelect.value;
        const centerNodeData = config.centerNodes.find(n => n.id === selectedCenterId);
        if (!centerNodeData) return;

        let currentResources = JSON.parse(JSON.stringify(config.resources));
        if (UIElements.civilizationSelect.value === 'byzantines') {
            const stone = currentResources.find(r => r.name === 'Stone');
            if (stone) stone.speedBonus += 0.05;
        }

        const optimalResource = currentResources.reduce((max, res) => res.speedBonus > max.speedBonus ? res : max, currentResources[0]);
        const centerResource = currentResources.find(r => r.name.toLowerCase() === selectedCenterId.split('_')[1]) || currentResources[0];
        const richResource = currentResources.find(r => r.name === UIElements.richResourceSelect.value) || optimalResource;
        
        const globalSpeedBonus = parseFloat(UIElements.globalSpeedSelect.value);
        const imperialTitleBonus = UIElements.imperialTitle.checked ? 0.10 : 0;
        const loadBonus = parseFloat(UIElements.loadBonusSelect.value);
        const egyptianLoadBonus = UIElements.civilizationSelect.value === 'egyptian' ? 0.05 : 0;
        const timeParts = UIElements.timeAtCenterInput.value.split(':').map(Number);
        const timeAtCenterHours = (timeParts[0] || 0) + ((timeParts[1] || 0) / 60);

        // 2. Core Calculations
        const finalMarchLoad = selectedMarch.baseLoad * (1 + loadBonus + egyptianLoadBonus);

        // 3. Determine Final Gather Step - find the node that offers the BIGGEST single load
        let finalGatherCandidates = [];
        
        // Add center if available
        if (centerNodeData.available) {
            const totalCenterSpeedBonus = selectedMarch.speedBonus + centerResource.speedBonus + globalSpeedBonus + imperialTitleBonus;
            const totalSpeedAtCenter = centerNodeData.baseSpeed * (1 + totalCenterSpeedBonus);
            const potentialGatherFromCenter = totalSpeedAtCenter * timeAtCenterHours;
            finalGatherCandidates.push({ ...centerNodeData, effectiveCapacity: potentialGatherFromCenter, isCenter: true });
        }
        
        // Add available, non-repeatable nodes
        config.nodes.filter(n => n.available && !n.repeatable).forEach(node => {
            finalGatherCandidates.push({ ...node, effectiveCapacity: node.capacity, isCenter: false });
        });

        // Sort to find the best one
        finalGatherCandidates.sort((a, b) => b.effectiveCapacity - a.effectiveCapacity);
        
        let finalGatherNodeData = finalGatherCandidates.length > 0 ? finalGatherCandidates[0] : null;

        // 4. Calculate Final Gather Plan & Prefill requirements
        let finalGatherPlan = { name: 'None', amount: 0, bonus: 0, time: 0 };
        let amountFromFinalNode = 0;
        
        if (finalGatherNodeData) {
            const nodeResource = finalGatherNodeData.isCenter ? centerResource : (finalGatherNodeData.name === 'T6 Rich' ? richResource : optimalResource);
            const speedBonus = selectedMarch.speedBonus + nodeResource.speedBonus + globalSpeedBonus + imperialTitleBonus;
            const effectiveSpeed = finalGatherNodeData.baseSpeed * (1 + speedBonus);
            
            amountFromFinalNode = Math.min(finalMarchLoad, finalGatherNodeData.effectiveCapacity);
            
            finalGatherPlan = {
                name: finalGatherNodeData.name,
                amount: amountFromFinalNode,
                bonus: amountFromFinalNode * selectedMarch.finalBonus, // This is the EXTRA bonus
                time: amountFromFinalNode > 0 ? amountFromFinalNode / effectiveSpeed : 0
            };
        }
        
        // 5. Generate Pre-fill Plan
        const loadRequiredFromPrefill = finalMarchLoad - amountFromFinalNode;
        const baseAmountForPrefill = loadRequiredFromPrefill; // Change: No division by bonus factor
        
        let tempAmountToPrefill = baseAmountForPrefill;
        let prefillPlan = [];

        let prefillPool = config.nodes.filter(n => n.available);
        if (finalGatherNodeData) { // Don't use final node for prefill unless it's repeatable
           if (!finalGatherNodeData.repeatable) {
               prefillPool = prefillPool.filter(n => n.name !== finalGatherNodeData.name);
           }
           // Special handling for resource center if it was the final gather node
           if (finalGatherNodeData.isCenter) {
               if (centerNodeData.repeatable) {
                  // It can also be in the prefill pool
                  prefillPool.push({...centerNodeData, isCenter: true, effectiveCapacity: Infinity});
               }
           } else if (centerNodeData.available && centerNodeData.repeatable) {
               // If a normal node was final gather, the center can still be in prefill if repeatable
               prefillPool.push({...centerNodeData, isCenter: true, effectiveCapacity: Infinity});
           }
        }


        prefillPool = prefillPool.map(node => {
            const isCenter = 'isCenter' in node;
            const nodeResource = isCenter ? centerResource : (node.name === 'T6 Rich' ? richResource : optimalResource);
            const speedBonus = selectedMarch.speedBonus + nodeResource.speedBonus + globalSpeedBonus + imperialTitleBonus;
            const effectiveSpeed = node.baseSpeed * (1 + speedBonus);
            return {...node, effectiveCapacity: node.capacity, effectiveSpeed, isCenter};
        }).sort((a, b) => b.effectiveSpeed - a.effectiveSpeed);

        while (tempAmountToPrefill > 0.01 && prefillPool.length > 0) {
            let bestNode = prefillPool[0];
            let capacity = bestNode.repeatable ? bestNode.capacity : bestNode.effectiveCapacity;

            if (capacity <= 0.01) {
                prefillPool.shift();
                continue;
            }

            const amountToTake = Math.min(tempAmountToPrefill, capacity);
            
            prefillPlan.push({
                name: bestNode.name,
                amount: amountToTake,
                bonus: amountToTake * selectedMarch.finalBonus,
                time: amountToTake / bestNode.effectiveSpeed
            });
            
            tempAmountToPrefill -= amountToTake;

            if (!bestNode.repeatable) {
                bestNode.effectiveCapacity -= amountToTake;
                if (bestNode.effectiveCapacity <= 0.01) {
                    prefillPool.shift();
                }
            }
        }


        // 6. Final results object
        const prefillBonusTotal = prefillPlan.reduce((sum, step) => sum + step.bonus, 0);
        const totalBonus = prefillBonusTotal + finalGatherPlan.bonus;
        const totalTime = prefillPlan.reduce((sum, step) => sum + step.time, 0) + finalGatherPlan.time;

        const results = {
            marchName: selectedMarch.name,
            finalMarchLoad,
            prefillPlan,
            centerPlan: finalGatherPlan,
            totalResources: finalMarchLoad + totalBonus, // Load + ALL bonuses
            bonusResources: totalBonus,
            optimalResourceName: optimalResource.name,
            totalTime: totalTime
        };

        renderResults(results);
    }
    
    function emptyResults() {
        return {
            marchName: '',
            finalMarchLoad: 0,
            prefillPlan: [],
            centerPlan: { name: 'No nodes available', amount: 0, bonus: 0, time: 0 },
            totalResources: 0,
            bonusResources: 0,
            optimalResourceName: 'N/A',
            totalTime: 0
        };
    }
    
    // --- RENDER RESULTS ---
    function renderResults(results) {
        UIElements.resultsContainer.innerHTML = '';

        function formatNumber(num) {
            return Math.round(num).toLocaleString();
        }

        function formatTime(hours) {
            if (!isFinite(hours)) return '00:00:00';
            const totalSeconds = hours * 3600;
            const h = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
            const s = Math.floor(totalSeconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        let html = '<div class="space-y-6">';

        // Prefill steps
        if (results.prefillPlan.length > 0) {
            results.prefillPlan.forEach((step, index) => {
                html += `
                    <div class="bg-gray-700/50 p-4 rounded-lg">
                        <p class="text-cyan-400 font-semibold">Step ${index + 1}: Pre-fill</p>
                        <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2 text-sm">
                            <div><strong>Node:</strong> <span class="text-gray-300">${step.name}</span></div>
                            <div><strong>Gather Amount:</strong> <span class="text-gray-300">${formatNumber(step.amount)}</span></div>
                            <div><strong>Bonus Gained:</strong> <span class="text-green-400 font-medium">+${formatNumber(step.bonus)}</span></div>
                            <div><strong>Est. Time:</strong> <span class="text-gray-300">${formatTime(step.time)}</span></div>
                        </div>
                    </div>
                `;
            });
        }
        
        // Center step / Final Gather
        if (results.centerPlan.amount > 0 || results.prefillPlan.length > 0) {
             const finalStepNumber = results.prefillPlan.length + 1;
             if (results.centerPlan.amount > 0) {
                html += `
                    <div class="bg-gray-700/50 p-4 rounded-lg">
                        <p class="text-cyan-400 font-semibold">Step ${finalStepNumber}: Final Gather</p>
                        <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2 text-sm">
                            <div><strong>Node:</strong> <span class="text-gray-300">${results.centerPlan.name}</span></div>
                            <div><strong>Gather Amount:</strong> <span class="text-gray-300">${formatNumber(results.centerPlan.amount)}</span></div>
                            <div><strong>Bonus Gained:</strong> <span class="text-green-400 font-medium">+${formatNumber(results.centerPlan.bonus)}</span></div>
                            <div><strong>Est. Time:</strong> <span class="text-gray-300">${formatTime(results.centerPlan.time)}</span></div>
                        </div>
                    </div>
                `;
             }
        } else {
             html += `<p class="text-center text-gray-400">No available nodes to create a plan.</p>`;
        }

        // Summary
        html += `
            <div class="border-t border-gray-700 pt-6 mt-6">
                <h3 class="text-xl font-semibold text-white mb-4">Summary</h3>
                <div class="space-y-2 text-base bg-gray-900/50 p-4 rounded-lg">
                     <div class="flex justify-between">
                        <span class="text-gray-400">Optimal Pre-fill Resource:</span>
                        <span class="font-bold text-white">${results.optimalResourceName}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Total Resources Gathered (incl. bonus):</span>
                        <span class="font-bold text-green-400">${formatNumber(results.totalResources)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Target March Load:</span>
                        <span class="font-medium text-gray-300">${formatNumber(results.finalMarchLoad)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Total Bonus Resources Gained:</span>
                        <span class="font-medium text-cyan-400">+ ${formatNumber(results.bonusResources)}</span>
                    </div>
                    <div class="flex justify-between border-t border-gray-700 mt-2 pt-2">
                        <span class="text-gray-400">Estimated Total Time:</span>
                        <span class="font-bold text-white">${formatTime(results.totalTime)}</span>
                    </div>
                </div>
                 <img src="https://raw.githubusercontent.com/Sombrero16/Gathering-planner/main/assets/pictures/image03.jpg" alt="Summary Banner" class="w-full h-auto mt-6 rounded-lg object-cover">
            </div>
        `;
        
        html += '</div>';
        UIElements.resultsContainer.innerHTML = html;
    }

    // --- START THE APP ---
    document.addEventListener('DOMContentLoaded', init);

</script>

</body>
</html>

